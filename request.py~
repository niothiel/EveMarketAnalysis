#/usr/bin/python
import urllib2
import xml.etree.ElementTree as ET

systems = {
	'rens': 10000030,
	'jita': 30000142
}

regions = {
	'the_forge': 10000002,
	'heimatar': 30002510
}

marketStatUrl = 'http://api.eve-central.com/api/marketstat?'
#statStr = 'http://api.eve-central.com/api/marketstat?typeid=%d&regionlimit=10000030'

typeToName = {}

def formatNum(price):
	if price < 1000:
		return str(price)
	if price < 1000000:
		return '%.1fk' % (price / 1000)
	
	return '%.1fM' % (price / 1000000)

class MarketItem:
	def __init__(self):
		self.name = None
		self.buyVolume = 0
		self.buyPrice = 0
		self.sellVolume = 0
		self.sellPrice = 0
		self.totalVolume = 0
		self.priceDifference = 0
		self.volumeDifference = 0

	def __repr__(self):
		s = self.name + '\n'
		s += 'Buy:\t' + str(self.buyVolume) + '\t@ ' + formatNum(self.buyPrice) + '\n'
		s += 'Sell:\t' + str(self.sellVolume) + '\t@ ' + formatNum(self.sellPrice) + '\n'

		s += 'Price Difference: %0.2f\n' % self.priceDifference
		s += 'Volume Difference: %0.2f' % self.volumeDifference
		return s

	def __str__(self):
		return self.__repr__()

def initTypeToNameDB():
	f = open('typeid.txt', 'r')
	for line in f:
		splitString = line.split('\t')
		typeId = splitString[0].strip()
		name = splitString[1].strip()
		typeToName[typeId] = name
	f.close()

def getItemName(typeId):
	if str(typeId) in typeToName:
		return typeToName[str(typeId)]
	else:
		return None

def getItems(typeIds, system=None, region=None):
	if len(typeIds) == 0:
		return []

	if system == None and region == None:			# If nothing's specified, just return
		return []

	items = []

	# Generate the url to use for the query
	url = marketStatUrl
	if system <> None:					# Set the system if we have one
		url += 'usesystem=%d&' % systems[system]
	if region <> None:					# Set the region if we have one
		url += 'regionlimit=%d&' % regions[region]
	for typeId in typeIds:					# Add all the typeids
		if getItemName(typeId) <> None:			# Check to make sure the thing actually exists.
			url += 'typeid=%d&' % typeId
	url = url[:-1]						# Strip the ending &

	print 'Using URL:', url

	htmlReply = urllib2.urlopen(url).read()
	root = ET.fromstring(htmlReply)[0]
	
	for typeNodes in root:
		item = getItemFromNode(typeNodes)
		if item <> None:
			items.append(item)

	return items

def getItemFromNode(itemNode):
	typeId = int(itemNode.attrib['id'])

	if getItemName(typeId) == None:
		return

	buyNode = itemNode.find('buy')
	sellNode = itemNode.find('sell')
	allNode = itemNode.find('all')

	m = MarketItem()
	m.name = getItemName(typeId)
	m.buyVolume = int(buyNode.find('volume').text)
	m.buyPrice = float(buyNode.find('max').text)
	m.sellVolume = int(sellNode.find('volume').text)
	m.sellPrice = float(sellNode.find('min').text)
	m.totalVolume = int(allNode.find('volume').text)

	if m.buyVolume == 0 or m.buyPrice == 0 or m.sellVolume == 0 or m.sellPrice == 0:
		m.priceDifference = 0
		m.volumeDifference = 0
	else:
		m.priceDifference = abs(m.buyPrice - m.sellPrice) / m.buyPrice * 100
		m.volumeDifference = abs(m.buyVolume - m.sellVolume) / float(m.totalVolume) * 100

	return m


def itemCriteria(item):
	if item.priceDifference < 20:
		return False
	if item.priceDifference > 200:
		return False
	elif item.totalVolume < 200:
		return False
	elif item.volumeDifference > 100:
		return False
	elif item.buyPrice < 30000:
		return False
	elif 'Blueprint' in item.name:
		return False
	else:
		return True

def sortCriteria(item):
	return item.priceDifference

def main():
	initTypeToNameDB()

	typeIds = range(34, 41) + range(178, 202) + range(377, 551) + range(551, 1357)
	itemList = getItems(typeIds, 'jita')

	itemList = filter(itemCriteria, itemList)
	itemList = sorted(itemList, key=sortCriteria)

	for item in itemList:
		print item, '\n'

if __name__ == '__main__':
	main()
